<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar dataset</title>
    <style>
        ${d.bootstrapCss}
        ${d.datatablesCss}
        ${d.select2Css}
        ${d.themeCss}

        #tabConstraints {
            padding: 10px 0;
        }

        .tab-content {
            margin-bottom: 15px;
        }

        #tabConstraints .table thead th {
            border-top: none;
        }

        #addConstraint {
            margin-right: 10px;
        }

        #tbResultDataset th, #tbResultDataset td {
            white-space: nowrap;
        }

        .selecionarCampos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: minmax(200px, auto);
            column-gap: 20px;
        }

        .list-sortable {
            list-style: none;
            padding-left: 0;
            border: 1px solid var(--vscode-input-border, var(--gray));
            max-height: 400px;
            overflow: scroll;
        }

        .list-sortable:first-child {
            border-left: none;
        }

        .list-sortable:last-child {
            border-right: none;
        }

        .list-sortable li {
            padding: .5rem;
            margin-bottom: .5rem;
            color: var(--vscode-button-foreground);
            background-color: var(--vscode-button-background);
            border-color: var(--vscode-button-separator);
        }

        .sortable-hover {
            cursor: move;
            color: #fff;
            background-color: var(--vscode-button-hoverBackground, var(--primary));
            border-color: var(--vscode-button-separator);
        }

        #tabOrders .custom-control-input {
            display: none;
        }

        #tabOrders .custom-switch {
            padding-left: 1.25rem;
        }

        #tabOrders .custom-control-label {
            cursor: pointer;
        }

        #tabOrders .custom-switch .custom-control-label::before {
            content: none;
        }

        #tabOrders .custom-switch .custom-control-label::after {
            top: 6px;
            left: -20px;
            width: 0px;
            height: 0px;
            border-style: solid;
            border-width: 0 7.5px 10px 7.5px;
            border-color: transparent transparent var(--vscode-editor-foreground) transparent;
            transform: rotate(0deg);
            border-radius: unset;
            background: none;
            cursor: pointer;
            transition: none;
        }

        #tabOrders .custom-switch .custom-control-input:checked~.custom-control-label::after {
            background: none;
            -webkit-transform: rotate(180deg);
            transform: rotate(180deg);
        }
    </style>
</head>
    <body class="container-fluid">
        <h1>${d.serverName}</h1>
        <div class="row">
            <div class="col-md-8 p-2">
                <select class="form-control" id="dataset" style="width: 100%;">
                    <option value=""></option>
                    ${d.datasets}
                </select>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary mt-2 mb-2" onclick="getResultQuery();">Consultar</button>
                <button type="button" class="btn btn-primary mt-2 mb-2" data-toggle="modal" data-target="#modalConfigFiltro">Configurar Parâmetros</button>
            </div>
        </div>

        <div class="text-center mt-5 d-none" id="loading">
            <div class="spinner-border text-primary ml-auto" style="width: 3rem; height: 3rem;" role="status" aria-hidden="true"></div>
            <p>Carregando</p>
        </div>

        <table id="tbResultDataset" class="table table-striped table-sm table-bordered"></table>

        <!-- Inicio Modal Constraints-->
        <div class="modal fade" id="modalConfigFiltro" tabindex="-1" role="dialog" aria-labelledby="modalConfigFiltro" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Parâmetros da Consulta</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#tabConstraints" role="tab" aria-controls="tabConstraints" aria-selected="true">Constraints</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#tabFields" role="tab" aria-controls="tabFields" aria-selected="true">Campos</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#tabOrders" role="tab" aria-controls="tabOrders" aria-selected="true">Ordem</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div id="tabConstraints" class="tab-pane fade show active" role="tabpanel" aria-labelledby="tabConstraints">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead>
                                            <tr>
                                                <th scope="col" width="30%">Coluna</th>
                                                <th scope="col" width="15%">Valor inicial</th>
                                                <th scope="col" width="15%">Valor final</th>
                                                <th scope="col" width="15%">Tipo</th>
                                                <th scope="col" width="15%" colspan="2">Usa 'like'</th>
                                            </tr>
                                        </thead>
                                        <tbody id="constraints">
                                            <tr>
                                                <td><input type="text" list="fieldsList" class="form-control" name="campo" value="sqlLimit"></td>
                                                <td><input type="text" class="form-control" name="valor_inicial" value="100"></td>
                                                <td><input type="text" class="form-control" name="valor_final" value="100"></td>
                                                <td>
                                                    <select class="form-control" name="tipo">
                                                        <option value="MUST" selected>MUST</option>
                                                        <option value="MUST_NOT">MUST NOT</option>
                                                        <option value="SHOULD">SHOULD</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select class="form-control" name="like">
                                                        <option value="NAO" selected>Não</option>
                                                        <option value="SIM">Sim</option>
                                                    </select>
                                                </td>
                                                <td class="text-center" style="vertical-align:middle"><a class="btn btn-sm btn-secondary" href="#" onClick="removeConstraints(this);">X</a></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 text-right">
                                        <button type="button" id="addConstraint" class="btn btn-primary" onclick="addConstraints();">Adicionar</button>
                                    </div>
                                </div>
                            </div>
                            <div id="tabFields" class="tab-pane fade" role="tabpanel" aria-labelledby="tabFields">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="text-center mt-3"><strong>Campos do Dataset</strong></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="text-center mt-3"><strong>Campos a Exibir</strong></p>
                                    </div>
                                </div>
                                <div class="selecionarCampos">
                                    <ul id="fieldsToSelect" class="list-sortable"></ul>
                                    <ul id="fieldsSelected" class="list-sortable"></ul>
                                </div>
                            </div>
                            <div id="tabOrders" class="tab-pane fade" role="tabpanel" aria-labelledby="tabOrders">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="text-center mt-3"><strong>Campos do Dataset</strong></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="text-center mt-3"><strong>Ordem</strong></p>
                                    </div>
                                </div>
                                <div class="selecionarCampos">
                                    <ul id="fieldsToOrder" class="list-sortable"></ul>
                                    <ul id="fieldsOrdered" class="list-sortable"></ul>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <dic class="col-md-12">
                                <button type="button" class="btn btn-primary" data-dismiss="modal" aria-label="Close" onclick="getResultQuery();">Atualizar Consulta</button>
                            </dic>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <datalist id="fieldsList">
            <option value="sqlLimit">
            <option value="tablename">
        </datalist>

        <!-- Fim Modal Constraints-->
        <script type="text/javascript">${d.jquery}</script>
        <script type="text/javascript">${d.bootstrapJs}</script>
        <script type="text/javascript">${d.select2Js}</script>
        <script type="text/javascript">${d.datatablesJs}</script>
        <script type="text/javascript">${d.html5SortableJs}</script>
        <script type="text/javascript">
            const vscode = acquireVsCodeApi();
            const FIELDS_TO_SELECT = "#fieldsToSelect";
            const FIELDS_SELECTED = "#fieldsSelected";

            const FIELDS_TO_ORDER = "#fieldsToOrder";
            const FIELDS_ORDERED = "#fieldsOrdered";

            let dataTable = null;
            let currentDataset = "";
            let resetItems = true;
            let FIELDS = [];
            let $loading = null;
            let $constraints = null;

            $(function () {
                $("#dataset").select2({
                    placeholder: "Selecione o Dataset"
                });

                $constraints = $("#constraints");

                sortable(FIELDS_TO_SELECT, {
                    acceptFrom: FIELDS_TO_SELECT + "," + FIELDS_SELECTED,
                    hoverClass: "sortable-hover",
                });

                sortable(FIELDS_SELECTED, {
                    acceptFrom: FIELDS_TO_SELECT + "," + FIELDS_SELECTED,
                    hoverClass: "sortable-hover",
                    itemSerializer: fieldsSelectedSerializer,
                });

                sortable(FIELDS_TO_ORDER, {
                    acceptFrom: FIELDS_TO_ORDER + "," + FIELDS_ORDERED,
                    hoverClass: "sortable-hover",
                });

                sortable(FIELDS_ORDERED, {
                    acceptFrom: FIELDS_TO_ORDER + "," + FIELDS_ORDERED,
                    hoverClass: "sortable-hover",
                    maxItems: 2,
                    itemSerializer: fieldsOrderedSerializer,
                });

                $loading = $("#loading");
            });

            window.addEventListener('message', event => {
                const message = event.data;

                switch (message.command) {
                    case 'query_result':
                        $loading.addClass("d-none");
                        const queryResult = message.queryResult

                        if (resetItems) {
                            setFields(queryResult);
                        }

                        updateTableResult(queryResult);
                        break;
                }
            });

            function updateTableResult(queryResult) {
                const {columns, values} = queryResult;

                const tbResult = document.getElementById('tbResultDataset');
                const $tbResult = $(tbResult);

                if (dataTable) {
                    dataTable.destroy();
                    $tbResult.empty();
                    dataTable = null;
                }

                tbResult.innerHTML = "";

                // Montando cabeçalho da tabela
                const header = tbResult.createTHead();
                const title = header.insertRow();

                for (let columnName of columns) {
                    const column = document.createElement('th');
                    column.innerHTML = columnName;
                    title.appendChild(column);
                }

                // Listando os registros
                const records = tbResult.appendChild(document.createElement('tbody'));

                for(let value of values) {
                    const row = records.insertRow();

                    for(let columnName of columns) {
                        row.insertCell().innerHTML = value[columnName];
                    }
                }

                tbResult.appendChild(records);

                dataTable = $tbResult.DataTable({
                    order: [],
                    fixedHeader: true,
                    dom: '<lf><rt><ip><B>',
                    buttons: ['copy', 'excel'],
                    scrollX: true,
                });
            }

            function getResultQuery() {
                const dataset = document.getElementById("dataset").value;

                if (!dataset) {
                    return;
                }

                $loading.removeClass("d-none");

                if (currentDataset != dataset) {
                    currentDataset = dataset;
                    resetItems = true;
                    resetConstraints();
                    resetFieldsSelect();
                } else {
                    resetItems = false;
                }

                vscode.postMessage({
                    command: 'consult_dataset',
                    datasetId: dataset,
                    fields: getFields(),
                    constraints: getConstraints(),
                    order: getOrders()
                });
            }

            function resetConstraints() {
                $constraints.empty();
                addConstraints(true);
            }

            function resetFieldsSelect() {
                $(FIELDS_TO_SELECT).empty();
                $(FIELDS_SELECTED).empty();
                $(FIELDS_TO_ORDER).empty();
                $(FIELDS_ORDERED).empty();
            }

            function reloadFieldsSelectSortable() {
                sortable(FIELDS_TO_SELECT);
                sortable(FIELDS_SELECTED);
                sortable(FIELDS_TO_ORDER);
                sortable(FIELDS_ORDERED);
            }

            function removeConstraints(element) {
                element.parentElement.parentElement.remove();
            }

            function addConstraints(isReset) {
                isReset = isReset || false;

                $constraints.append(
                    '<tr>'
                    + '<td><input type="text" list="fieldsList" class="form-control" name="campo" ' + (isReset ? 'value="sqlLimit"' : '') + '></td>'
                    + '<td><input type="text" class="form-control" name="valor_inicial" ' + (isReset ? 'value="100"' : '') + '></td>'
                    + '<td><input type="text" class="form-control" name="valor_final" ' + (isReset ? 'value="100"' : '') + '></td>'
                    + '<td>'
                        + '<select class="form-control" name="tipo">'
                            + '<option value="1">MUST</option>'
                            + '<option value="3">MUST NOT</option>'
                            + '<option value="2">SHOULD</option>'
                        + '</select>'
                    + '</td>'
                    + '<td>'
                        + '<select class="form-control" name="like">'
                            + '<option value="NAO">Não</option>'
                            + '<option value="SIM">Sim</option>'
                        + '</select>'
                    + '</td>'
                    + '<td class="text-center" style="vertical-align:middle"><a class="btn btn-sm btn-secondary" href="#" onClick="removeConstraints(this);">X</a></td>'
                    + '</tr>'
                );
            }

            function getConstraints() {
                const rows = $constraints.find("tr");

                let datasetConstraints = [];

                for (let row of rows) {
                    const fields = $(row).find(".form-control");

                    datasetConstraints.push({
                        fieldName: fields[0].value,
                        initialValue: fields[1].value,
                        finalValue: fields[2].value,
                        contraintType: fields[3].value,
                        likeSearch: fields[4].value == "SIM"
                    });
                }

                return datasetConstraints;
            }

            function getFields() {
                let items = sortable(FIELDS_SELECTED, "serialize")[0].items;
                return items.map(item => item.field);
            }

            function getOrders() {
                let items = sortable(FIELDS_ORDERED, "serialize")[0].items;
                return items.map(item => item.field);
            }

            function setFields(queryResult) {
                const {columns} = queryResult;

                FIELDS = columns;
                let fieldsToSelect = [];
                let fieldsToOrder = [];

                const fieldsList = $("#fieldsList");

                fieldsList.empty();

                for (let optionName of columns) {
                    const option = new Option(optionName, optionName);
                    fieldsList.append(option);
                    fieldsToSelect.push("<li>"+ optionName + "</li>");
                    fieldsToOrder.push('<li><div class="custom-control custom-switch">'
                        + '<input type="checkbox" class="custom-control-input" id="' + optionName + '">'
                        + '<label class="custom-control-label" for="' + optionName + '">' + optionName + '</label>'
                        + '</div></li>'
                    );
                }

                fieldsList.append(new Option("sqlLimit", "sqlLimit"));
                fieldsList.append(new Option("tablename", "tablename"));
                $(FIELDS_TO_SELECT).append(fieldsToSelect);
                $(FIELDS_TO_ORDER).append(fieldsToOrder);

                reloadFieldsSelectSortable();
            }

            function fieldsSelectedSerializer(serializedItem, sortableContainer) {
                return {
                    field: serializedItem.html.replace(/<[^>]+>([^>]+)<.*>/, '$1'),
                }
            }

            function fieldsOrderedSerializer(serializedItem, sortableContainer) {
                let field = serializedItem.html.replace(/.*<label[^>]+>([^>]+)<.*>.*/, '$1');
                let checkbox = document.getElementById(field);

                if (checkbox && checkbox.checked) {
                    field += ";desc";
                }

                return {
                    field,
                }
            }
        </script>
    </body>
</html>
